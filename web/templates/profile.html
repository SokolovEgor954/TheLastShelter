{% extends "base.html" %}
{% set active_page = 'profile' %}

{% block title %}–ü—Ä–æ—Ñ—ñ–ª—å ‚Äî {{ user.nickname }} ‚Äî –û—Å—Ç–∞–Ω–Ω—ñ–π –ü—Ä–∏—Ö–∏—Å—Ç–æ–∫{% endblock %}

{% block extra_head %}
<style>
/* ‚îÄ‚îÄ –ê–≤–∞—Ç–∞—Ä-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚îÄ‚îÄ */
.profile-avatar {
    width: 100px;
    height: 100px;
    border: 2px solid #4cff80;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.6rem;
    background: rgba(76,255,128,0.07);
    box-shadow: 0 0 18px rgba(76,255,128,0.35), inset 0 0 20px rgba(76,255,128,0.05);
    flex-shrink: 0;
    animation: avatarPulse 3s ease-in-out infinite;
}

@keyframes avatarPulse {
    0%, 100% { box-shadow: 0 0 18px rgba(76,255,128,0.35), inset 0 0 20px rgba(76,255,128,0.05); }
    50%       { box-shadow: 0 0 30px rgba(76,255,128,0.6),  inset 0 0 30px rgba(76,255,128,0.1); }
}

/* ‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚îÄ‚îÄ */
.stat-card {
    border: 1px solid rgba(76,255,128,0.4);
    padding: 18px 20px;
    border-radius: 4px;
    background: rgba(10,15,10,0.92);
    text-align: center;
    transition: 0.2s;
    flex: 1;
    min-width: 130px;
}
.stat-card:hover {
    border-color: #4cff80;
    box-shadow: 0 0 14px rgba(76,255,128,0.3);
}
.stat-value {
    font-size: 2.2rem;
    font-weight: bold;
    color: #4cff80;
    text-shadow: 0 0 12px rgba(76,255,128,0.9);
    display: block;
}
.stat-label {
    font-size: 0.78rem;
    opacity: 0.65;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
}

/* ‚îÄ‚îÄ –°–µ–∫—Ü—ñ—ó –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é –ø–æ—è–≤–∏ ‚îÄ‚îÄ */
.profile-section {
    opacity: 0;
    transform: translateY(14px);
    animation: fadeUp 0.4s ease forwards;
}
.profile-section:nth-child(1) { animation-delay: 0.05s; }
.profile-section:nth-child(2) { animation-delay: 0.15s; }
.profile-section:nth-child(3) { animation-delay: 0.25s; }
.profile-section:nth-child(4) { animation-delay: 0.35s; }

@keyframes fadeUp {
    to { opacity: 1; transform: translateY(0); }
}

/* ‚îÄ‚îÄ –Ü–Ω–ø—É—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é ‚îÄ‚îÄ */
.input-haven {
    width: 100%;
    background: rgba(5,10,5,0.85);
    border: 1px solid #4cff80;
    padding: 10px 14px;
    color: #4cff80;
    font-family: "Share Tech Mono", monospace;
    font-size: 1rem;
    border-radius: 4px;
    outline: none;
    transition: 0.2s;
    box-sizing: border-box;
}
.input-haven:focus {
    border-color: #8affb8;
    box-shadow: 0 0 12px rgba(76,255,128,0.45);
}

/* ‚îÄ‚îÄ –ë–µ–π–¥–∂ —Ä–æ–ª—ñ ‚îÄ‚îÄ */
.role-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 3px;
    font-size: 0.78rem;
    letter-spacing: 1px;
    text-transform: uppercase;
}
.role-admin {
    border: 1px solid #ff4444;
    color: #ff4444;
    text-shadow: 0 0 6px rgba(255,68,68,0.6);
}
.role-user {
    border: 1px solid #4cff80;
    color: #4cff80;
    opacity: 0.75;
}

/* ‚îÄ‚îÄ Typing cursor ‚îÄ‚îÄ */
.typing-cursor::after {
    content: '‚ñã';
    animation: blink 1s step-start infinite;
}
@keyframes blink { 50% { opacity: 0; } }
</style>
{% endblock %}

{% block content %}

<!-- Flash –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-haven alert-{{ category }} mb-3">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- ‚ïê‚ïê HEADER –ü–ê–ù–ï–õ–¨ ‚ïê‚ïê -->
<div class="terminal-panel mb-4 profile-section">
    <div class="terminal-header d-flex justify-content-between align-items-center">
        <span class="terminal-title">[ –û–°–û–ë–û–í–ê –°–ü–†–ê–í–ê ]</span>
        <span class="terminal-code">NODE: PROFILE-{{ user.id }}</span>
    </div>

    <div class="terminal-body">
        <div class="d-flex align-items-center gap-4 flex-wrap mt-2">

            <!-- –ê–≤–∞—Ç–∞—Ä -->
            <div class="profile-avatar">{{ user.nickname[0].upper() }}</div>

            <!-- –Ü–Ω—Ñ–æ -->
            <div>
                <h2 class="terminal-highlight mb-1 typing-cursor">{{ user.nickname }}</h2>
                <div class="mb-2" style="opacity:0.7; font-size:0.9rem;">
                    ‚ò¢ {{ user.email }}
                </div>
                <span class="role-badge {% if user.nickname == 'Admin' %}role-admin{% else %}role-user{% endif %}">
                    {% if user.nickname == 'Admin' %}‚ö† –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä{% else %}‚ò¢ –í—Ü—ñ–ª—ñ–ª–∏–π{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê –°–¢–ê–¢–ò–°–¢–ò–ö–ê ‚ïê‚ïê -->
<div class="terminal-panel mb-4 profile-section">
    <div class="terminal-header mb-3">
        <span class="terminal-title">[ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–ò–ñ–ò–í–ê–ù–ù–Ø ]</span>
    </div>
    <div class="d-flex gap-3 flex-wrap">
        <div class="stat-card">
            <span class="stat-value">{{ orders_count }}</span>
            <div class="stat-label">–ó–∞–º–æ–≤–ª–µ–Ω—å</div>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ reserv_count }}</span>
            <div class="stat-label">–ë—Ä–æ–Ω—é–≤–∞–Ω—å</div>
        </div>
        <div class="stat-card">
            <span class="stat-value">#{{ user.id }}</span>
            <div class="stat-label">ID –≤–∏–∂–∏–≤—à–∏</div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê –®–í–ò–î–ö–Ü –î–Ü–á ‚ïê‚ïê -->
<div class="terminal-panel mb-4 profile-section">
    <div class="terminal-header mb-3">
        <span class="terminal-title">[ –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ]</span>
    </div>
    <div class="d-flex gap-3 flex-wrap">
        <a href="/my_orders" class="btn btn-haven">‚ò∞ –ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
        <a href="/my_reservations" class="btn btn-haven">ü™ë –ú–æ—ó –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</a>
        {% if user.nickname == 'Admin' %}
        <a href="/menu_check" class="btn btn-haven" style="border-color:#ff4444; color:#ff4444;">‚ö† –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</a>
        {% endif %}
    </div>
</div>

<!-- ‚ïê‚ïê –ó–ú–Ü–ù–ê –ü–ê–†–û–õ–Ø ‚ïê‚ïê -->
<div class="terminal-panel mb-4 profile-section">
    <div class="terminal-header d-flex justify-content-between align-items-center mb-3">
        <span class="terminal-title">[ –ó–ú–Ü–ù–ê –ü–ê–†–û–õ–Ø ]</span>
        <span class="terminal-code" style="font-size:0.75rem; opacity:0.6;">SECURITY MODULE</span>
    </div>

    <form method="post" action="/profile/change_password">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="mb-3">
            <label class="form-label-haven">–ü–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" name="old_password" required class="input-haven" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ—Ç–æ—á–Ω–∏–π –ø–∞—Ä–æ–ª—å">
        </div>

        <div class="mb-3">
            <label class="form-label-haven">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" name="new_password" required class="input-haven" placeholder="–ú—ñ–Ω—ñ–º—É–º 8 —Å–∏–º–≤–æ–ª—ñ–≤" minlength="8">
        </div>

        <div class="mb-4">
            <label class="form-label-haven">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è</label>
            <input type="password" name="confirm_password" required class="input-haven" placeholder="–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å" minlength="8">
        </div>

        <button type="submit" class="btn btn-haven w-100">
            ‚ò¢ –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å
        </button>
    </form>
</div>

<!-- ‚ïê‚ïê TELEGRAM ‚ïê‚ïê -->
<div class="terminal-panel mb-4 profile-section">
    <div class="terminal-header d-flex justify-content-between align-items-center mb-3">
        <span class="terminal-title">[ TELEGRAM ]</span>
        <span class="terminal-code" style="font-size:0.75rem; opacity:0.6;">LINK MODULE</span>
    </div>
    <div class="terminal-body">
        {% if user.telegram_chat_id %}
            <p style="color:#4cff80;">‚úÖ –ê–∫–∞—É–Ω—Ç –ø—Ä–∏–≤'—è–∑–∞–Ω–æ –¥–æ Telegram.</p>
            <form method="post" action="/profile/telegram_unlink">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-danger-haven w-100">‚ö† –í—ñ–¥–≤'—è–∑–∞—Ç–∏ Telegram</button>
            </form>
        {% else %}
            <p style="opacity:0.6; font-size:0.9rem;">> –ü—Ä–∏–≤'—è–∂—ñ—Ç—å Telegram —â–æ–± –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è.</p>

            {% if session.get('telegram_code') %}
            <div style="border:1px dashed rgba(76,255,128,0.5); padding:14px; border-radius:4px; margin-bottom:14px; text-align:center;">
                <div style="font-size:0.75rem; opacity:0.5; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px;">–í–∞—à –∫–æ–¥ (–¥—ñ–π—Å–Ω–∏–π 10 —Ö–≤–∏–ª–∏–Ω)</div>
                <div style="font-size:2rem; color:#4cff80; text-shadow:0 0 14px rgba(76,255,128,0.9); letter-spacing:6px; font-weight:bold;">
                    {{ session.get('telegram_code') }}
                </div>
                <div style="font-size:0.8rem; opacity:0.5; margin-top:8px;">–í–≤–µ–¥—ñ—Ç—å —Ü–µ–π –∫–æ–¥ —É –Ω–∞—à–æ–≥–æ Telegram-–±–æ—Ç–∞</div>
            </div>
            {% endif %}

            <form method="post" action="/profile/telegram_link">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-haven w-100">
                    ‚úà {{ '–û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–≤–∏–π –∫–æ–¥' if session.get('telegram_code') else '–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥' }}
                </button>
            </form>
        {% endif %}
    </div>
</div>

<!-- ‚ïê‚ïê –í–ò–•–Ü–î ‚ïê‚ïê -->
<div class="terminal-panel profile-section">
    <div class="terminal-body">
        <p style="opacity:0.6; font-size:0.9rem;">> –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É —Å–µ—Å—ñ—é —Ç–∞ –≤–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏ —É–∫—Ä–∏—Ç—Ç—è.</p>
        <form method="post" action="/logout">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger-haven w-100">
                ‚ö† –í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç–∞
            </button>
        </form>
    </div>
</div>

{% endblock %}